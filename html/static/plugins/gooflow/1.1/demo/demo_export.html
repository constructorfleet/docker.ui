<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Flowchart-Export图片</title>
    <!--[if lt IE 9]>
    <?import namespace="v" implementation="#default#VML" ?>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="../codebase/GooFlow.css"/>
    <script type="text/javascript" src="data2.js"></script>
    <script type="text/javascript" src="../plugin/jquery.min.js"></script>
    <script type="text/javascript" src="../codebase/GooFunc.js"></script>
    <script type="text/javascript" src="../plugin/json2.js"></script>
    <link rel="stylesheet" type="text/css" href="default.css"/>
    <script type="text/javascript" src="../codebase/GooFlow.js"></script>
    <script type="text/javascript" src="../codebase/GooFlow.color.js"></script>

    <script type="text/javascript" src="../plugin/promise.min.js"></script>
    <script type="text/javascript" src="../plugin/html2canvas.min.js"></script>
    <!--[if lte IE 11]-->
    <script type="text/javascript" src="../plugin/canvg.js"></script>
    <!--[endif]-->
    <script type="text/javascript" src="../codebase/GooFlow.export.js"></script>

    <script type="text/javascript">
       var property={
            width:1200,
            height:540,
            toolBtns:["start round mix","end round","task","node","chat","state","plug","join","fork","complex mix"],
            haveHead:true,
            headLabel:true,
            headBtns:["new","open","save","undo","redo","reload","print"],//IfhaveHead=true，DefinitionsHEADSector button
            haveTool:true,
            haveGroup:true,
            useOperStack:true
        };
        var remark={
            cursor:"Selection指针",
            direct:"Connect points",
            start:"Entry Node",
            "end":"End Node",
            "task":"Tasks结点",
            node:"Auto结点",
            chat:"Decision Node",
            state:"Status Node",
            plug:"Attach Plugin",
            fork:"Branch Node",
            "join":"Joint Node",
            "complex":"Composite Node",
            group:"Organisation Box Edit Switches"
        };
        var demo;
        $(function(){
            demo=$.createGooFlow($("#demo"),property);
            demo.setNodeRemarks(remark);
            demo.loadData(jsondata);

            //以下是测试Export图片功能
//            demo.onPrintClick=function(){
//                //0.Add临时元素
//                $("body").append('<div id="demo_export" style="position:absolute;top:0;left:0;z-index:-1;width:0px;height:0px;overflow:hidden">'
//                    +'<div style="color:#15428B;position:absolute;left:0;right:0;width:1160px;height:507px;overflow:hidden;float:none;" class="GooFlow GooFlow_work"></div>'
//                    +'</div>');
//
//                //1.先COPYNodes和区块的内容
//                var inner = $("#demo").find(".GooFlow_work_inner");
//                var divCanvas = $("#demo_export").children("div:eq(0)");
//                //CopyNodes的内容
//                inner.children("div").each(function(i){
//                    var item=$(this);
//                    if(item.hasClass("GooFlow_item")){
//                        item.clone().removeAttr("id").css("position","absolute").appendTo(divCanvas);
//                    }else if(item.hasClass("GooFlow_work_group")){
//                        item.clone().removeAttr("id").css("position","absolute")
//                            .attr("xmlns",'http://www.w3.org/1999/xhtml').appendTo(divCanvas);
//                    }
//                });
//                html2canvas(divCanvas[0], {
//                    allowTaint: false, taintTest: false,
//                    onrendered: function(canvas) {
//                        //2.In return mode，COPYConnect Content
//                        //Make a temporaryIMAGE
//                        var context = canvas.getContext('2d');//Get the canvas2d绘图Context
//                        context.save();
//                        var strSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="1160" height="507">'
//                                +'<defs><style type="text/css">text{font-size:14px;line-height:1.42857143;'
//                                +'font-family:"Microsoft Yahei", "Helvetica Neue", Helvetica, Hiragino Sans GB, WenQuanYi Micro Hei, Arial, sans-serif;'
//                                +'}</style></defs>' + window.$("<svg>").append(window.$("#draw_demo").clone()).html() +'</svg>'; //COPYConnect Content
//                        var image = null;
//                        if(!!window.ActiveXObject || "ActiveXObject" in window){//AsIE11及以下Version浏览器时，UseCanvgThird party tool
//                            image = document.createElement('canvas');
//                            canvg(image, strSvg);
//                        }else{
//                            var image = new Image();
//                            image.src='data:image/svg+xml,'+ encodeURIComponent(strSvg);
//                        }
//                        var tempFunc=function(){
//                           context.drawImage(image, 0, 0);
//                            //Clear不需要的临时DOM
//                            $("#demo_export").empty().remove();
//                            try{
//                                var blob = canvas.msToBlob();
//                                //alert("blob2");
//                                navigator.msSaveBlob(blob, "prettyImage.png");
//                            }
//                            catch(e){
//                                //Generate a download link and click
//                                var a = document.createElementNS("http://www.w3.org/1999/xhtml", "a")
//                                a.href = canvas.toDataURL('image/png');  //将画布内的信息Export为png图片Data
//                                a.download = "prettyImage.png";  //Set Download Name
//                                document.body.appendChild(a);
//                                a.click(); //Click to trigger download
//                                document.body.removeChild(a);
//                            }
//                        }
//
//                        if(image.complete|| (!!window.ActiveXObject || "ActiveXObject" in window)) { // If图片已经存在于浏览器缓存，Direct Callback Function
//                            console.log("aaa");
//                            tempFunc();
//                            return;// Direct Return，No more handlingonloadEvents
//                        }
//                        image.onload=function(){
//                            console.log("ccc");
//                            tempFunc();
//                        };
//                    },
//                    width: 1160,
//                    height: 507
//                });
//            }
            demo.onPrintClick=function(){demo.exportDiagram("fuckyou");}
            //Export图片功能 END
        });
    </script>
</head>
<body>
<div id="demo" style="margin:10px"></div>
<!--demo.$workArea.width(),demo.$workArea.height(),-->
<div id="fff"></div>
</body>
</html>